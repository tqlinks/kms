<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapleStory Captcha Challenge - 0796750236</title>

    <style>
        /* --- 1. PHONG C√ÅCH CHUNG & N·ªÄN (GAME UI) --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #E0F7FA; /* N·ªÅn xanh nh·∫°t t∆∞∆°i m·ªõi */
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background: #FFFFFF;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            border: 3px solid #0D47A1; /* Vi·ªÅn xanh ƒë·∫≠m ki·ªÉu UI Game */
            width: 100%;
            max-width: 900px; /* TƒÉng max-width ƒë·ªÉ ch·ª©a ph·∫ßn th·ªëng k√™ */
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }
        
        /* Chia b·ªë c·ª•c ch√≠nh (Start Screen) */
        #start-screen {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .main-col {
            flex: 1 1 450px; /* C·ªôt ch√≠nh, t·ªëi thi·ªÉu 450px */
            min-width: 300px;
        }

        h1 {
            color: #0D47A1;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2em;
            text-shadow: 1px 1px 0 #BBDEFB;
            width: 100%; /* ƒê·∫£m b·∫£o ti√™u ƒë·ªÅ chi·∫øm h·∫øt chi·ªÅu r·ªông container */
        }
        
        h2 {
            color: #0D47A1;
            margin-top: 0;
            border-bottom: 2px solid #BBDEFB;
            padding-bottom: 10px;
            font-size: 1.3em;
        }

        /* --- 2. B·∫¢NG ƒêI·ªÇM & INPUT --- */
        .score-board {
            display: flex;
            justify-content: space-between;
            background-color: #BBDEFB;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #0D47A1;
        }

        .score-item {
            text-align: center;
            flex: 1;
            padding: 0 5px;
        }

        .score-value {
            display: block;
            font-size: 1.2em;
            color: #E65100;
        }

        #captcha-image {
            width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 20px;
            border: 4px solid #0D47A1;
            border-radius: 8px;
            background-color: #fff;
            padding: 5px;
            box-sizing: border-box;
        }

        #captcha-input {
            width: 100%;
            padding: 12px 10px;
            margin-bottom: 15px;
            border: 2px solid #0D47A1;
            border-radius: 8px;
            font-size: 1.1em;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        /* --- 3. N√öT ƒêI·ªÄU KHI·ªÇN (BUTTONS) --- */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .controls button,
        #game-area button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px #0D47A1; 
            flex-grow: 1;
        }
        
        .controls button:active,
        #game-area button:active {
             transform: translateY(2px);
             box-shadow: 0 2px #0D47A1;
        }

        #btn-start {
            background-color: #FFCA28;
            color: #0D47A1;
            box-shadow: 0 4px #FF8F00;
            font-size: 1.2em;
        }
        #btn-start:hover {
            background-color: #FFECB3;
        }

        .controls button:not(#btn-start),
        #btn-submit, #btn-hint {
            background-color: #90CAF9;
            color: #0D47A1;
            box-shadow: 0 4px #42A5F5;
        }

        #btn-exit {
            background-color: #E57373 !important;
            box-shadow: 0 4px #C62828 !important;
            color: white !important;
            width: 100%;
            margin-top: 20px;
        }

        /* --- 4. LIST CHUNG (BXH & TH·ªêNG K√ä) --- */
        #top10-list, .stats-list {
            list-style: none;
            padding: 0;
            font-size: 1em;
        }
        #top10-list li, .stats-list li {
            padding: 8px 0;
            border-bottom: 1px dashed #E0E0E0;
            display: flex;
            justify-content: space-between;
        }
        #top10-list li:first-child {
            color: #FF8F00;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .stats-list li {
            border-bottom: 1px dotted #BBDEFB;
            font-size: 0.95em;
        }

        /* --- 5. THANH TH√îNG B√ÅO ONLINE & M∆ØA --- */
        #online-announcement-container {
            width: 100%;
            max-width: 900px;
            margin-top: 10px;
            background-color: #ffe0b2;
            color: #e65100;
            padding: 5px 0;
            border-radius: 5px;
            border: 1px solid #ffcc80;
            overflow: hidden;
            position: relative;
            z-index: 5;
        }
        #online-announcement-text {
            margin: 0;
            white-space: nowrap;
            font-weight: bold;
            font-size: 1.1em;
            display: inline-block;
        }

        @keyframes scroll-left {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .rain-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
            pointer-events: none;
        }
        .rain-drop {
            position: absolute;
            background: linear-gradient(to bottom, rgba(173, 216, 230, 0.8), rgba(173, 216, 230, 0.3));
            width: 1px;
            transform: translateY(-100vh);
            animation-name: fall;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }
        @keyframes fall {
            to { transform: translateY(100vh); }
        }

        /* --- 6. UTILITIES --- */
        .hidden {
            display: none !important;
        }
        #feedback-message {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    
    <div class="rain-container"></div>
    
    <div class="container">
        <h1>MapleStory Captcha Challenge 0796750236</h1>

        <div id="start-screen">
            
            <div class="main-col">
                 <div class="score-board">
                    <div class="score-item">
                        Ng∆∞·ªùi ch∆°i: <span id="player-name">Kh√°ch</span>
                    </div>
                    <div class="score-item">
                        ƒêi·ªÉm cao nh·∫•t: <span id="highest-score" class="score-value">0</span>
                    </div>
                </div>

                <div class="controls">
                    <button id="btn-register">üìù Ghi Danh</button>
                    <button id="btn-start">‚ñ∂Ô∏è B·∫Øt ƒê·∫ßu Tr√≤ Ch∆°i</button>
                </div>
                
                <div id="top10-area" style="margin-top: 30px;">
                    <h2>üèÜ B·∫£ng X·∫øp H·∫°ng Top 10 (Online)</h2>
                    <ul id="top10-list">
                        <li>ƒêang t·∫£i...</li>
                    </ul>
                </div>
                <div id="online-status-area" style="margin-top: 30px;">
                    <h2>üåê Ng∆∞·ªùi Ch∆°i Online (<span id="online-count">0</span>)</h2>
                    <ul id="online-list" class="stats-list">
                    <li>ƒêang t·∫£i...</li>
                </ul>
</div>
            </div>
            
            <div class="main-col">
                <div id="stats-area">
                    <h2>üìä Th·ªëng K√™ Captcha (Online)</h2>
                    <div style="display: flex; gap: 20px;">
                         <div style="flex: 1;">
                            <h3>‚úÖ C√¢u h·ªèi D·ªÑ nh·∫•t (ƒê√∫ng)</h3>
                            <ul id="top-correct-list" class="stats-list">
                                <li>ƒêang t·∫£i th·ªëng k√™...</li>
                            </ul>
                        </div>
                        <div style="flex: 1;">
                            <h3>‚ùå C√¢u h·ªèi KH√ì nh·∫•t (Sai)</h3>
                            <ul id="top-incorrect-list" class="stats-list">
                                <li>ƒêang t·∫£i th·ªëng k√™...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="game-screen" class="hidden"> 
            
            <div class="score-board">
                <div class="score-item">
                    Ng∆∞·ªùi ch∆°i: <span id="player-name-game">Kh√°ch</span>
                </div>
                <div class="score-item">
                    ƒêi·ªÉm: <span id="current-score" class="score-value">0</span>
                </div>
                <div class="score-item">
                    C√¢u h·ªèi: <span id="question-count">0/99 (60s)</span>
                </div>
            </div>

            <div id="game-area">
                <img id="captcha-image" src="" alt="Captcha Image">
                <input type="text" id="captcha-input" placeholder="Nh·∫≠p ƒë√°p √°n ·ªü ƒë√¢y..." autocomplete="off">
                <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 10px;">
                    <button id="btn-submit" style="flex-grow: 1;">‚úÖ G·ª≠i ƒê√°p √Ån</button>
                    <button id="btn-hint" class="hidden" style="flex-grow: 1;">üí° Xem ƒê√°p √Ån (-100)</button>
                </div>
                <p id="feedback-message">S·∫µn s√†ng...</p>
                <button id="btn-exit">üö™ Tho√°t Game</button>
            </div>
        </div>
    </div>
    
    <div id="online-announcement-container">
        <p id="online-announcement-text"></p>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // --- 0. KH·ªûI T·∫†O FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAXUYaRgG63eVVDpfiQAsWbZVr9Ze_8JPA",
            authDomain: "kmscaptcha.firebaseapp.com",
            projectId: "kmscaptcha",
            storageBucket: "kmscaptcha.firebasestorage.app",
            messagingSenderId: "164719590340",
            appId: "1:164719590340:web:b8d3f7e0a8f2c1de3c4291"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        window.db = db;
    </script>

    <script>
        <div id="online-users-area" class="container">
            <h2>üë• Ng∆∞·ªùi ch∆°i ƒëang online</h2>
            <ul id="online-player-list">
            <li>Vui l√≤ng Ghi Danh ƒë·ªÉ ki·ªÉm tra...</li>
            </ul>
        </div>
        document.addEventListener('DOMContentLoaded', () => {
            const db = window.db; 
            
            // --- Khai b√°o c√°c ph·∫ßn t·ª≠ DOM ---
            const startScreen = document.getElementById('start-screen');
            const gameScreen = document.getElementById('game-screen');
            const btnStart = document.getElementById('btn-start');
            const btnRegister = document.getElementById('btn-register');
            const btnExit = document.getElementById('btn-exit'); 
            
            const highestScoreSpan = document.getElementById('highest-score');
            const top10List = document.getElementById('top10-list');
            const topCorrectList = document.getElementById('top-correct-list');
            const topIncorrectList = document.getElementById('top-incorrect-list');
            
            const btnSubmit = document.getElementById('btn-submit');
            const btnHint = document.getElementById('btn-hint'); 
            const captchaImage = document.getElementById('captcha-image');
            const captchaInput = document.getElementById('captcha-input');
            const feedbackMessage = document.getElementById('feedback-message');
            const currentScoreSpan = document.getElementById('current-score');
            const questionCountSpan = document.getElementById('question-count');
            const playerNameSpan = document.getElementById('player-name');
            const playerNameGameSpan = document.getElementById('player-name-game'); 
            const onlineAnnouncementText = document.getElementById('online-announcement-text');
            
            // M·ªöI: DOM cho ch·ª©c nƒÉng Online
            const onlineCountSpan = document.getElementById('online-count');
            const onlineList = document.getElementById('online-list');
            
            // --- Bi·∫øn Tr·∫°ng th√°i Tr√≤ ch∆°i ---
            let score = 0;
            let playerName = localStorage.getItem('playerName') || 'Kh√°ch';
            let questionsAnswered = 0;
            const MAX_QUESTIONS = 99; 
            let currentCaptcha = null;
            let availableCaptchas = []; 
            let consecutiveCorrects = 0; 
            
            // --- Bi·∫øn Th·ªùi gian & ƒêi·ªÉm ---
            let timer; 
            let timeLeft = 60;
            const TIME_LIMIT = 60;
            const SCORE_CORRECT = 100;
            const SCORE_INCORRECT = -100;
            const SCORE_TIMEOUT = -100;
            const SCORE_HINT = -100;

            // --- D·ªØ li·ªáu 99 Captcha (Gi·ªØ nguy√™n) ---
            const ALL_CAPTCHAS_DATA = [
                // ... (D·ªØ li·ªáu Captcha gi·ªØ nguy√™n) ...
                { file: '1.gif', answer: 'Ï°∞ÏàòÎ∏îÎ£®ÏäµÍ≤©Ïûê' }, { file: '2.gif', answer: 'Ïù¥ÌîÑÏÜêÏû°Ïù¥' }, { file: '3.gif', answer: 'Î†àÏù¥Î≤åÏ≥ê' },
                { file: '4.gif', answer: 'ÏóêÎìúÏóòÎ¶¨' }, { file: '5.gif', answer: 'ÌîÑÍ∏∞Í∞ëÎ≥ë' }, { file: '6.gif', answer: 'ÏÉàÏö∞Í∞ÄÎ©¥' },
                { file: '7.gif', answer: 'ÌÇ§ÎùºÎùºÎ£ΩÏπºÎ°ú' }, { file: '8.gif', answer: 'Ìä∏Îü¨Î∏îÎ©îÏù¥Ïª§' }, { file: '9.gif', answer: 'Î≤ÑÌÅ¨ÏÜêÎãòÎåÄÏã†Í¥Ä' },
                { file: '10.gif', answer: 'ÏßÄÍ∑∏Î¶¨ÎìúÏòêÎ°úÏö∞' }, { file: '11.gif', answer: 'ÌòÑÏûêÎ†âÏä§ÌÉïÌÉïÏïÑ' }, { file: '12.gif', answer: 'Î¶¨Ïä§ÌÉÑÏùòÏòÅ' },
                { file: '13.gif', answer: 'ÏñºÏñ¥Î∂àÏùÄÌóàÎ¨¥' }, { file: '14.gif', answer: 'Ìä∏Îü¨Î∏îÎ©îÏù¥' }, { file: '15.gif', answer: 'ÎìúÎûòÍ≥§ÌÑ∞ÌãÄ' },
                { file: '16.gif', answer: 'Î∂âÏùÄÎ™®ÎûòÎÇúÏüÅÏù¥' }, { file: '17.gif', answer: 'Íµ¨Ï≤úÎ°ùÎÖ∏Î∞îÏßÄÏõê' }, { file: '18.gif', answer: 'Ïò¨Î¶¨ÎπÑÏïÑÌïëÌÅ¨Îπà' },
                { file: '19.gif', answer: 'Ìô©Î£°ÏïÑÍ∏∞Î∞î' }, { file: '20.gif', answer: 'Ï∂îÎäîÎπ®Í∞ÑÍµ¨' }, { file: '21.gif', answer: 'ÌÉÄÌîΩÏãúÎç∞Îì§' },
                { file: '22.gif', answer: 'Îì§Î¶¨ÎîîÏä§Ìä∏Î°úÏù¥' }, { file: '23.gif', answer: 'Ï≤ºÎ¶≠Î≤ÑÏä§' }, { file: '24.gif', answer: 'ÎìúÎûòÍ≥§ÌÑ∞ÌãÄ' },
                { file: '25.gif', answer: 'ÏïåÎ≤†Î•¥Ìä∏' }, { file: '26.gif', answer: 'ÌÉÄÍ∑∏ÎûòÏù¥' }, { file: '27.gif', answer: 'ÏûÉÏùÄÍ∑∏Î†àÏù¥' },
                { file: '28.gif', answer: 'ÏóºÎêúÏàòÏï°ÏÇêÎπÖ' }, { file: '29.gif', answer: 'ÎìúÎ¶≠Ï≤¥ÌÇ§Ïä§ÏΩî' }, { file: '30.gif', answer: 'Ï£ºÏãúÌïòÎäî' },
                { file: '31.gif', answer: 'ÏñºÏñ¥Î∂àÏùÄÍ≥†ÎèÖ' }, { file: '32.gif', answer: 'Ïù¥Î®∏ÌååÎûÄÎ≤ÑÏÑØ' }, { file: '33.gif', answer: 'ÎçîÌÇ§Ìå®Î∞Ä' },
                { file: '34.gif', answer: 'ÏãúÏïΩÏùòÌîºÏ°∞' }, { file: '35.gif', answer: 'Ïû•Î†àÏòπÎ™®Î¶¨' }, { file: '36.gif', answer: 'ÏóêÎç∏ÏäàÌÉÄÏù∏Í≤åÏãú' },
                { file: '37.gif', answer: 'Î†âÏä§ÎùºÏùºÎùº' }, { file: '38.gif', answer: 'Î∏åÎùºÏö¥ÌÖå' }, { file: '39.gif', answer: 'ÌååÎ•¥ÎßàÏóòÎ¶¨Ïüà' },
                { file: '40.gif', answer: 'Îç∞Îì§Î¶¨ÏïÑÏö∏' }, { file: '41.gif', answer: 'Î°úÏù¥Ïä§ÌÅ∞Ìé≠Í∂å' }, { file: '42.gif', answer: 'ÎπÑÏò¨Î†àÌÉÄÏú†Î¶¨Í¥Ä' },
                { file: '43.gif', answer: 'Î∂àÍΩÉÏùòÏÇ¨' }, { file: '44.gif', answer: 'Îì§Î¶¨ÎîîÏä§Ìä∏Î°úÏù¥' }, { file: '45.gif', answer: 'Í≥ÑÏùòÏ†úÎã®' },
                { file: '46.gif', answer: 'ÏãúÎØ∏ÏïÑÎÇòÎ≠áÍ∞ÄÏßÄ' }, { file: '47.gif', answer: 'Îí∑Í≥®Î™©ÏùòÏ†úÏù¥Ïó†' }, { file: '48.gif', answer: 'Ïä§ÌÖêÎÖ∏Î¨¥Ïá†' },
                { file: '49.gif', answer: 'Î≤®Î£®Ïñ¥Î≤§Ï†úÎ°¨' }, { file: '50.gif', answer: 'Ï¢ÖÏûêÏùòÏàòÌïò' }, { file: '51.gif', answer: 'Ïò¨Î¶¨Î≤ÑÍ≤®ÎåÄÏä§ÏΩú' },
                { file: '52.gif', answer: 'ÎßêÏàòÏ†ÅÏùÄ' }, { file: '53.gif', answer: 'ÏºàÎ†àÌÜ§Î∞ÄÎ¶¨ÏÉ§' }, { file: '54.gif', answer: 'Î¶¨Ïä§ÎßàÏä§ÏºÄÏù¥ÌÅ¨' },
                { file: '55.gif', answer: 'Ìï¥ÏãúÌÉúÍ∑∏Ìè∞' }, { file: '56.gif', answer: 'Î¶¨ÌîÑÎö±Îö±Ïù¥Îùº' }, { file: '57.gif', answer: 'ÏßÄÏãúÍ∑∏ÎÑàÏä§ÌïòÏä§' },
                { file: '58.gif', answer: 'Îã§ÌÅ¨ÏòàÌã∞ÏôÄ' }, { file: '59.gif', answer: 'ÏûêÏïÑÏä§ÌÖÄÌîº' }, { file: '60.gif', answer: 'Î†πÏù¥ÍπÉÎì†Ìë∏' },
                { file: '61.gif', answer: 'Î∞ÄÎùºÌÉÄÏö∞Î°úÎßà' }, { file: '62.gif', answer: 'ÌÇ§ÎàÑÏïÑÎ¶¨ÏÜî' }, { file: '63.gif', answer: 'ÎùºÏÜîÎπôÌïòÏàòÌÜ†Í∏∞' }, 
                { file: '64.gif', answer: 'Ïä§ÌÉÄÏö∞Î°úÎßàÏãú' }, { file: '65.gif', answer: 'ÌïúÏóêÎ•¥Îã§Ïä§' }, { file: '66.gif', answer: 'ÏãúÍ∑∏ÎÑàÏä§' },
                { file: '67.gif', answer: 'Î¨ºÍ∞àÏÉâÎ™®ÎûòÌÜ†ÎÅº' }, { file: '68.gif', answer: 'ÌÅ¨Î¶¨Ïä§ÌÉàÍ≤åÏù¥' }, { file: '69.gif', answer: 'ÎãàÏüÅÍ∏∞ÏÜåÏùÄÏõî' },
                { file: '70.gif', answer: 'Í∞ïÎ†•ÌïúÍΩÉÎç§Î∂à' }, { file: '71.gif', answer: 'ÌÇ®ÏóêÎ∞òÌïúÍ≤®Ïö∏' }, { file: '72.gif', answer: 'Ìò∏Î¨∏Î™ΩÎïÖÏ∞®ÌÅ¨Î°ú' },
                { file: '73.gif', answer: 'Î≤ÑÏä§Ïä§ÏºàÎ†àÌÜ§ÎÇò' }, { file: '74.gif', answer: 'Ïñ¥Îë†ÏùòÏßëÌñâÏûê' }, { file: '75.gif', answer: 'ÎùºÏù¥ÏñÄÏÇºÎã®ÏßÄ' },
                { file: '76.gif', answer: 'ÎπÑÏòÅÏõÖÏùÑÏïåÏïÑÎ≥¥' }, { file: '77.gif', answer: 'Ïä§Ìã∞Ïò®Ïù¥Ïπ¥Î•¥Ìä∏' }, { file: '78.gif', answer: 'Í∑∏Î¶¥Ïä§Ìôî' },
                { file: '79.gif', answer: 'ÌÜ§Î∞ÄÎ¶¨ÏÉ§' }, { file: '80.gif', answer: 'ÎÇòÏù∏ÌïòÌä∏' }, { file: '81.gif', answer: 'Ìä∏Î°úÏù¥Ïñ¥' },
                { file: '82.gif', answer: 'ÏßÄÍ∑∏Î¨∏Ìä∏Ïúå' }, { file: '83.gif', answer: 'ÌåúÏò§Î≤†Î°†' }, { file: '84.gif', answer: 'ÏΩòÌä∏ÎùºÎ≤†Ïù¥Ïä§Îß®' },
                { file: '85.gif', answer: 'ÎßàÏä§ÌÑ∞Ìò∏Î∏å' }, { file: '86.gif', answer: 'Ìù•Î∂ÄÎ™®ÏΩî' }, { file: '87.gif', answer: 'ÏòêÎ°úÏö∞Î∂àÍΩÉÎßàÏù¥' },
                { file: '88.gif', answer: 'Ìä∏Îü¨Î∏îÎ©îÏù¥Ïª§' }, { file: '89.gif', answer: 'Î¶¨Í¥ÄÏûëÏùÄÎ∂àÏî®' }, { file: '90.gif', answer: 'Ïä§Ìã∏ÎùºÏû•ÎÇúÍ∞êÎ™©' },
                { file: '91.gif', answer: 'Î∏åÎ¶¨Ìó§ÎÑ§' }, { file: '92.gif', answer: 'ÌÖåÏùºÏùòÏôºÏ™ΩÎ®∏' }, { file: '93.gif', answer: 'Ïù∏Îß§Í∑∏ÎÑàÏä§' },
                { file: '94.gif', answer: 'Ìã±Ïù¥Í≥ÑÏùòÏÇ¨' }, { file: '95.gif', answer: 'ÌååÌååÌîΩÏãúÏïÑÏπ¥Ïù¥' }, { file: '96.gif', answer: 'Í∏âÎãåÏûêÎ∏îÎ°ùÌçºÏä§' },
                { file: '97.gif', answer: 'ÎãàÏπ¥Ïö∏Î¶¨Ïπ¥' }, { file: '98.gif', answer: 'Ïã†Ïä§ÌéôÌÑ∞' }, { file: '99.gif', answer: 'ÏπºÎùºÏùºÌòºÎèà' }
            ];
            // --- End D·ªØ li·ªáu Captcha ---

            playerNameSpan.textContent = playerName;


            // --- 1. H√†m C·∫≠p nh·∫≠t ƒêi·ªÉm v√† S·ªë c√¢u h·ªèi (Gi·ªØ nguy√™n) ---
            function updateScore(change) {
                score += change;
                currentScoreSpan.textContent = score;
                questionCountSpan.textContent = `${questionsAnswered}/${MAX_QUESTIONS} (${timeLeft}s)`;
            }

            // --- 1.5. C·∫≠p nh·∫≠t Th·ªëng k√™ Captcha (Gi·ªØ nguy√™n) ---
            async function updateCaptchaStats(file, isCorrect) {
                if (!db) return;
                
                const fieldToIncrement = isCorrect ? 'correct_count' : 'incorrect_count';
                const captchaRef = db.collection('captcha_stats').doc(file);

                try {
                    await captchaRef.set({
                        file: file,
                        [fieldToIncrement]: firebase.firestore.FieldValue.increment(1),
                    }, { merge: true });
                } catch (e) {
                    console.error("[Firebase]: L·ªói khi c·∫≠p nh·∫≠t th·ªëng k√™ Captcha:", e);
                }
            }


            // --- 2. Qu·∫£n l√Ω ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c (Gi·ªØ nguy√™n) ---
            function startTimer() {
                clearInterval(timer); 
                timeLeft = TIME_LIMIT;
                questionCountSpan.textContent = `${questionsAnswered}/${MAX_QUESTIONS} (${timeLeft}s)`;
                
                timer = setInterval(() => {
                    timeLeft--;
                    questionCountSpan.textContent = `${questionsAnswered}/${MAX_QUESTIONS} (${timeLeft}s)`;

                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        handleTimeout();
                    }
                }, 1000); 
            }
            
            // --- X·ª≠ l√Ω khi h·∫øt gi·ªù (Gi·ªØ nguy√™n) ---
            function handleTimeout() {
                btnHint.classList.add('hidden'); 
                consecutiveCorrects = 0; 
                updateScore(SCORE_TIMEOUT); 
                feedbackMessage.textContent = `‚ùå H·∫æT GI·ªú! B·∫°n b·ªã tr·ª´ ${-SCORE_TIMEOUT} ƒëi·ªÉm. Chu·ªói ƒë√∫ng b·ªã RESET!`;
                
                if (currentCaptcha) {
                    updateCaptchaStats(currentCaptcha.file, false);
                }
                
                if (questionsAnswered < MAX_QUESTIONS) {
                    setTimeout(setRandomCaptcha, 1500);
                } else {
                    endGame();
                }
            }


            // --- 3. Thi·∫øt l·∫≠p Captcha Ng·∫´u nhi√™n (Gi·ªØ nguy√™n) ---
            function setRandomCaptcha() {
                if (availableCaptchas.length === 0) {
                    endGame();
                    return;
                }
                questionsAnswered++; 
                
                const randomIndex = Math.floor(Math.random() * availableCaptchas.length);
                currentCaptcha = availableCaptchas[randomIndex];

                availableCaptchas.splice(randomIndex, 1);

                captchaImage.src = `${currentCaptcha.file}`;
                captchaImage.alt = `Captcha: ${currentCaptcha.file}`;
                captchaInput.value = ''; 
                captchaInput.focus();
                feedbackMessage.textContent = 'H√£y nh·∫≠p ƒë√°p √°n...';
                
                btnHint.classList.add('hidden'); 
                startTimer();
            }
            
            // --- 4. B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i (Gi·ªØ nguy√™n) ---
            btnStart.addEventListener('click', () => {
                if (playerName === 'Kh√°ch') {
                    alert('Vui l√≤ng nh·∫•n "Ghi Danh" v√† nh·∫≠p t√™n tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu tr√≤ ch∆°i!');
                    return;
                }
                
                startScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                
                playerNameGameSpan.textContent = playerName; 

                score = 0;
                questionsAnswered = 0; 
                consecutiveCorrects = 0; 
                updateScore(0);
                availableCaptchas = [...ALL_CAPTCHAS_DATA]; 
                
                setRandomCaptcha();
            });
            
            // --- 5. L∆∞u Top Score Online (Gi·ªØ nguy√™n) ---
            async function saveTopScoreOnline(name, finalScore) {
                if (finalScore <= 0 || !db) return; 

                const scoreRef = db.collection('top_scores').doc(name); 

                try {
                    const doc = await scoreRef.get();
                    let shouldUpdate = false;

                    if (!doc.exists) {
                        shouldUpdate = true;
                    } else {
                        const currentScore = doc.data().score;
                        if (finalScore > currentScore) {
                            shouldUpdate = true;
                        }
                    }

                    if (shouldUpdate) {
                        await scoreRef.set({
                            name: name,
                            score: finalScore,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }, {merge: true});
                    }
                } catch (e) {
                    console.error("[Firebase]: L·ªói khi l∆∞u ƒëi·ªÉm:", e);
                }
            }
            
            // --- 6. K·∫øt th√∫c/Tho√°t Tr√≤ ch∆°i (Th√™m trackUserPresence) ---
            async function exitToStartScreen(isEndGame = false) {
                clearInterval(timer);
                currentCaptcha = null; 
                
                const finalScore = score;
                const finalQuestions = questionsAnswered;

                if (isEndGame) {
                    alert(`üéâ CH√öC M·ª™NG ${playerName}! B·∫°n ƒë√£ ho√†n th√†nh ${finalQuestions} c√¢u h·ªèi v·ªõi t·ªïng ƒëi·ªÉm l√†: ${finalScore}!`);
                    await saveTopScoreOnline(playerName, finalScore); 
                } else {
                    if (finalQuestions > 0 && finalScore > 0) {
                        alert(`Game ƒë√£ d·ª´ng. ƒêi·ªÉm s·ªë: ${finalScore}. ƒêi·ªÉm s·∫Ω ƒë∆∞·ª£c l∆∞u.`);
                        await saveTopScoreOnline(playerName, finalScore); 
                    } else {
                         alert(`Game ƒë√£ d·ª´ng. ƒêi·ªÉm s·ªë: ${finalScore}. ƒêi·ªÉm kh√¥ng ƒë∆∞·ª£c l∆∞u do <= 0.`);
                    }
                }
                
                gameScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
                displayTop10Online(); 
                displayTopStats();
            }
            
            function endGame() {
                exitToStartScreen(true);
            }
            
            btnExit.addEventListener('click', () => {
                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën tho√°t game? ƒêi·ªÉm hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c l∆∞u (n·∫øu d∆∞∆°ng).')) {
                    exitToStartScreen(false);
                }
            });

            // --- 7. G·ª≠i Th√¥ng B√°o Chu·ªói ƒê√∫ng (Gi·ªØ nguy√™n) ---
            async function sendOnlineNotification(name, currentScore, streak) {
                if (!db || streak < 10) return;
                
                const message = `${name} v·ª´a ƒë·∫°t chu·ªói ${streak} c√¢u ƒë√∫ng li√™n ti·∫øp! T·ªïng ƒëi·ªÉm: ${currentScore}.`;
                
                try {
                    await db.collection('notifications').doc('latest').set({
                        message: message,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        streak: streak,
                        name: name
                    });
                } catch (e) {
                    console.error("[Firebase]: L·ªói khi g·ª≠i th√¥ng b√°o online:", e);
                }
            }


            // --- 8. Ki·ªÉm tra ƒê√°p √°n (Gi·ªØ nguy√™n) ---
            btnSubmit.addEventListener('click', () => {
                // ... (Logic ki·ªÉm tra ƒë√°p √°n gi·ªØ nguy√™n) ...
                if (!currentCaptcha) {
                      feedbackMessage.textContent = '‚ùå H√£y b·∫•m "B·∫Øt ƒê·∫ßu Tr√≤ Ch∆°i"!';
                      return;
                }
                
                clearInterval(timer);
                
                const userInput = captchaInput.value.trim();
                const correctAnswer = currentCaptcha.answer.trim();

                if (userInput === correctAnswer) {
                    consecutiveCorrects++;
                    const timeBonus = timeLeft; 
                    const streakBonus = consecutiveCorrects * 5; 
                    const totalScoreChange = SCORE_CORRECT + timeBonus + streakBonus;
                    
                    updateScore(totalScoreChange); 
                    feedbackMessage.innerHTML = `
                        ‚úÖ Ch√≠nh x√°c! +${SCORE_CORRECT} ƒëi·ªÉm, +${timeBonus} ƒëi·ªÉm th∆∞·ªüng th·ªùi gian. 
                        ${consecutiveCorrects > 1 ? `+${streakBonus} ƒëi·ªÉm th∆∞·ªüng chu·ªói (${consecutiveCorrects}x)!` : ''} 
                        T·ªïng c·ªông: +${totalScoreChange} ƒëi·ªÉm.
                    `;
                    
                    if (consecutiveCorrects >= 10) {
                        sendOnlineNotification(playerName, score, consecutiveCorrects);
                    }
                    
                    updateCaptchaStats(currentCaptcha.file, true);
                    btnHint.classList.add('hidden'); 
                    
                    if (questionsAnswered < MAX_QUESTIONS) {
                        setTimeout(setRandomCaptcha, 1000); 
                    } else {
                        endGame();
                    }
                    
                } else {
                    consecutiveCorrects = 0; 
                    updateScore(SCORE_INCORRECT); 
                    feedbackMessage.textContent = `‚ùå Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}. Chu·ªói ƒë√∫ng b·ªã RESET! B·∫°n b·ªã tr·ª´ ${-SCORE_INCORRECT} ƒëi·ªÉm. Th·ª≠ l·∫°i ho·∫∑c Xem ƒê√°p √°n.`;
                    
                    updateCaptchaStats(currentCaptcha.file, false);
                    captchaInput.value = ''; 
                    captchaInput.focus();
                    btnHint.classList.remove('hidden'); 
                    startTimer(); 
                }
            });
            
            // --- 9. Ch·ª©c nƒÉng Xem ƒê√°p √°n (Gi·ªØ nguy√™n) ---
            btnHint.addEventListener('click', () => {
                // ... (Logic xem ƒë√°p √°n gi·ªØ nguy√™n) ...
                if (!currentCaptcha || score < -SCORE_HINT) { 
                      alert('B·∫°n c·∫ßn c√≥ √≠t nh·∫•t 100 ƒëi·ªÉm ƒë·ªÉ xem ƒë√°p √°n!');
                      return;
                }
                
                clearInterval(timer);
                consecutiveCorrects = 0; 
                updateScore(SCORE_HINT); 
                
                const correctAnswer = currentCaptcha.answer.trim();
                const userInput = captchaInput.value.trim(); 
                
                feedbackMessage.innerHTML = `
                    üí° ƒê√ÅP √ÅN ƒê√öNG: "<strong>${correctAnswer}</strong>" <br>
                    B·∫°n ƒë√£ g√µ: "<strong>${userInput}</strong>" <br>
                    B·∫°n b·ªã tr·ª´ ${-SCORE_HINT} ƒëi·ªÉm. Chu·ªói ƒë√∫ng b·ªã RESET! Chuy·ªÉn c√¢u sau 30 gi√¢y.
                `;
                
                updateCaptchaStats(currentCaptcha.file, false);

                captchaInput.value = correctAnswer;
                
                btnHint.classList.add('hidden'); 

                if (questionsAnswered < MAX_QUESTIONS) {
                    setTimeout(setRandomCaptcha, 30000); 
                } else {
                    endGame(); 
                }
            });


            // Cho ph√©p Enter ƒë·ªÉ submit
            captchaInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    btnSubmit.click();
                }
            });

            // --- 10. H√†m Ghi Danh (C·∫≠p nh·∫≠t v√† g·ªçi trackUserPresence) ---
            btnRegister.addEventListener('click', () => {
                const nameInput = prompt('Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i c·ªßa b·∫°n (T√™n s·∫Ω d√πng ƒë·ªÉ l∆∞u ƒëi·ªÉm):', playerName === 'Kh√°ch' ? '' : playerName);
                if (nameInput && nameInput.trim() !== '') {
                    const oldName = playerName;
                    playerName = nameInput.trim();
                    localStorage.setItem('playerName', playerName); 
                    playerNameSpan.textContent = playerName; 
                    playerNameGameSpan.textContent = playerName;
                    
                    alert(`Ch√†o m·ª´ng, ${playerName}! B·∫°n ƒë√£ s·∫µn s√†ng ch∆°i!`);
                    
                    // M·ªöI: C·∫≠p nh·∫≠t tr·∫°ng th√°i online v·ªõi t√™n m·ªõi
                    if (oldName !== playerName && oldName !== 'Kh√°ch') {
                         // X√≥a t√™n c≈© (n·∫øu c√≥)
                         db.collection('online_users').doc(oldName).delete().catch(console.error);
                    }
                    trackUserPresence(); 
                }
            });

            // --- 11. Hi·ªÉn th·ªã Top 10 ONLINE (Gi·ªØ nguy√™n) ---
            async function displayTop10Online() {
                // ... (Logic gi·ªØ nguy√™n) ...
                if (!db) {
                    top10List.innerHTML = '<li>L·ªói: Ch∆∞a k·∫øt n·ªëi ƒë∆∞·ª£c Firebase.</li>';
                    return;
                } 

                top10List.innerHTML = '<li>ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</li>';

                try {
                    const snapshot = await db.collection('top_scores')
                        .orderBy('score', 'desc')
                        .orderBy('timestamp', 'asc') 
                        .limit(10)          
                        .get();

                    let topScores = [];
                    let maxScore = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        topScores.push(data);
                        if (data.score > maxScore) maxScore = data.score;
                    });
                    
                    highestScoreSpan.textContent = maxScore;

                    top10List.innerHTML = ''; 

                    if (topScores.length === 0) {
                        top10List.innerHTML = '<li>Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o ghi ƒëi·ªÉm cao.</li>';
                        return;
                    }

                    topScores.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span><strong>#${index + 1}</strong>: ${item.name}</span> <span><strong>${item.score}</strong> ƒëi·ªÉm</span>`;
                        top10List.appendChild(li);
                    });

                } catch (e) {
                    console.error("[Firebase]: L·ªói khi t·∫£i Top 10:", e);
                    top10List.innerHTML = '<li>L·ªói k·∫øt n·ªëi Server. Vui l√≤ng ki·ªÉm tra console.</li>';
                }
            }
            
            // --- 11.5. Hi·ªÉn th·ªã Th·ªëng k√™ C√¢u h·ªèi (Gi·ªØ nguy√™n) ---
            async function displayTopStats() {
                 // ... (Logic gi·ªØ nguy√™n) ...
                if (!db) {
                    topCorrectList.innerHTML = '<li>L·ªói: Ch∆∞a k·∫øt n·ªëi ƒë∆∞·ª£c Firebase.</li>';
                    topIncorrectList.innerHTML = '<li>L·ªói: Ch∆∞a k·∫øt n·ªëi ƒë∆∞·ª£c Firebase.</li>';
                    return;
                }
                
                const getCaptchaName = (file) => {
                    const captcha = ALL_CAPTCHAS_DATA.find(c => c.file === file);
                    return captcha ? `**${captcha.answer}** (${file})` : file;
                };

                // --- Top ƒê√∫ng Nh·∫•t ---
                try {
                    const correctSnapshot = await db.collection('captcha_stats')
                        .orderBy('correct_count', 'desc')
                        .limit(5)
                        .get();
                        
                    topCorrectList.innerHTML = '';
                    if (correctSnapshot.empty) {
                        topCorrectList.innerHTML = '<li>Ch∆∞a c√≥ d·ªØ li·ªáu.</li>';
                    } else {
                        correctSnapshot.forEach((doc, index) => {
                            const data = doc.data();
                            const li = document.createElement('li');
                            const name = getCaptchaName(data.file);
                            li.innerHTML = `<span><strong>#${index + 1}</strong> ${name}</span> <span>${data.correct_count || 0} l·∫ßn</span>`;
                            topCorrectList.appendChild(li);
                        });
                    }
                } catch (e) {
                    console.error("[Firebase]: L·ªói t·∫£i Top ƒê√∫ng:", e);
                    topCorrectList.innerHTML = '<li>L·ªói t·∫£i th·ªëng k√™.</li>';
                }

                // --- Top Sai Nh·∫•t ---
                try {
                    const incorrectSnapshot = await db.collection('captcha_stats')
                        .orderBy('incorrect_count', 'desc')
                        .limit(5)
                        .get();
                        
                    topIncorrectList.innerHTML = '';
                    if (incorrectSnapshot.empty) {
                        topIncorrectList.innerHTML = '<li>Ch∆∞a c√≥ d·ªØ li·ªáu.</li>';
                    } else {
                        incorrectSnapshot.forEach((doc, index) => {
                            const data = doc.data();
                            const li = document.createElement('li');
                            const name = getCaptchaName(data.file);
                            li.innerHTML = `<span><strong>#${index + 1}</strong> ${name}</span> <span>${data.incorrect_count || 0} l·∫ßn</span>`;
                            topIncorrectList.appendChild(li);
                        });
                    }
                } catch (e) {
                    console.error("[Firebase]: L·ªói t·∫£i Top Sai:", e);
                    topIncorrectList.innerHTML = '<li>L·ªói t·∫£i th·ªëng k√™.</li>';
                }
            }

            // --- 13. M·ªöI: Theo d√µi Tr·∫°ng th√°i Hi·ªán di·ªán (Presence) ---
            function trackUserPresence() {
                if (playerName === 'Kh√°ch' || !db) return;
                
                const userRef = db.collection('online_users').doc(playerName);
                
                // 1. C·∫≠p nh·∫≠t tr·∫°ng th√°i online khi ng∆∞·ªùi ch∆°i m·ªü trang
                userRef.set({
                    name: playerName,
                    online: true,
                    last_seen: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(console.error);

                // 2. T·ª± ƒë·ªông x√≥a tr·∫°ng th√°i online khi ng∆∞·ªùi ch∆°i ƒë√≥ng/refresh trang
                // CH√ö √ù: Firebase Firestore kh√¥ng c√≥ onDisconnect API. Ch√∫ng ta s·∫Ω d√πng 
                // s·ª± ki·ªán window unload ƒë·ªÉ m√¥ ph·ªèng (tuy kh√¥ng ho√†n h·∫£o) ho·∫∑c b·∫°n c√≥ th·ªÉ 
                // d√πng Realtime Database cho t√≠nh nƒÉng Presence chu·∫©n h∆°n.
                
                window.addEventListener('beforeunload', () => {
                    // C·ªë g·∫Øng x√≥a document khi ng∆∞·ªùi ch∆°i r·ªùi ƒëi
                    userRef.delete().catch(console.error);
                });
            }
            
            // --- 13.5. M·ªöI: Hi·ªÉn th·ªã Ng∆∞·ªùi d√πng Online ---
            function displayOnlineUsers() {
                 if (!db) {
                    onlineList.innerHTML = '<li>L·ªói: Ch∆∞a k·∫øt n·ªëi ƒë∆∞·ª£c Firebase.</li>';
                    return;
                }
                
                db.collection('online_users')
                    .onSnapshot(snapshot => {
                        onlineList.innerHTML = '';
                        const onlinePlayers = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.online) {
                                onlinePlayers.push(data.name);
                            }
                        });

                        onlineCountSpan.textContent = onlinePlayers.length;

                        if (onlinePlayers.length === 0) {
                            onlineList.innerHTML = '<li>Kh√¥ng c√≥ ng∆∞·ªùi ch∆°i n√†o online.</li>';
                        } else {
                            onlinePlayers.forEach((name, index) => {
                                const li = document.createElement('li');
                                li.innerHTML = `<span>${index + 1}. <strong>${name}</strong></span> <span>üü¢ ƒêang ch∆°i</span>`;
                                onlineList.appendChild(li);
                            });
                        }
                    }, err => {
                        console.error("[Firebase]: L·ªói l·∫Øng nghe Online Users:", err);
                        onlineList.innerHTML = '<li>L·ªói k·∫øt n·ªëi Server.</li>';
                    });
            }


            // --- 14. L·∫Øng Nghe Th√¥ng B√°o Online (Gi·ªØ nguy√™n) ---
            function setupOnlineNotificationListener() {
                // ... (Logic gi·ªØ nguy√™n) ...
                 if (!db) {
                    onlineAnnouncementText.textContent = 'L·ªói k·∫øt n·ªëi Firebase.';
                    return;
                }
                
                db.collection('notifications').doc('latest')
                    .onSnapshot(doc => {
                        const animationDuration = 10; 
                        if (doc.exists) {
                            const data = doc.data();
                            const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : 'V·ª´a r·ªìi';
                            const message = `üåü [ONLINE] ${data.message} (l√∫c ${time})`;
                            onlineAnnouncementText.textContent = message;
                            
                            onlineAnnouncementText.style.animation = `scroll-left ${animationDuration}s linear infinite`;
                            
                        } else {
                            onlineAnnouncementText.textContent = 'üéâ Ch√†o m·ª´ng ƒë·∫øn v·ªõi Captcha Challenge! H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n ƒë·∫°t 10 chu·ªói ƒë√∫ng!';
                            onlineAnnouncementText.style.animation = `scroll-left ${animationDuration}s linear infinite`;
                        }
                    }, err => {
                        console.error("[Firebase]: L·ªói l·∫Øng nghe th√¥ng b√°o:", err);
                        onlineAnnouncementText.textContent = 'L·ªói k·∫øt n·ªëi th√¥ng b√°o online.';
                        onlineAnnouncementText.style.animation = 'none';
                    });
            }

            // --- 15. KH·ªûI T·∫†O HI·ªÜU ·ª®NG M∆ØA (Gi·ªØ nguy√™n) ---
            function createRainEffect() {
                // ... (Logic gi·ªØ nguy√™n) ...
                const container = document.querySelector('.rain-container');
                const numberOfDrops = 100;
                
                for (let i = 0; i < numberOfDrops; i++) {
                    const drop = document.createElement('div');
                    drop.classList.add('rain-drop');
                    
                    drop.style.left = `${Math.random() * 100}%`;
                    
                    const duration = Math.random() * 1.2 + 0.8;
                    drop.style.animationDuration = `${duration}s`;
                    
                    const delay = Math.random() * 2;
                    drop.style.animationDelay = `-${delay}s`;
                    
                    const size = Math.random() * 20 + 20;
                    drop.style.height = `${size}px`;
                    
                    drop.style.opacity = Math.random() * 0.5 + 0.3;

                    container.appendChild(drop);
                }
            }

            // --- Kh·ªüi ch·∫°y c√°c ch·ª©c nƒÉng ban ƒë·∫ßu ---
            createRainEffect();
            displayTop10Online();
            displayTopStats(); 
            setupOnlineNotificationListener(); 
            
            // M·ªöI: Kh·ªüi t·∫°o theo d√µi online
            trackUserPresence(); 
            displayOnlineUsers(); 
            
            questionCountSpan.textContent = `0/${MAX_QUESTIONS} (${TIME_LIMIT}s)`;
        });
    </script>

</body>
</html>








